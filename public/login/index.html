<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Logowanie – Aplikacja</title>
  <link rel="stylesheet" href="/login/style.css" />
  <!-- Widget Identity (dla sesji i eventów) -->
  <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
  <!-- Spójna logika sesji/nawigacji -->
  <script defer src="/assets/js/auth.js"></script>
</head>
<body>
  <div class="wrapper">
    <div class="tabs" role="tablist">
      <button class="tab-btn active" data-target="login" type="button">Logowanie</button>
      <button class="tab-btn" data-target="signup" type="button">Rejestracja</button>
    </div>
    <div id="flash" class="flash" aria-live="polite"></div>

    <!-- Logowanie -->
    <form id="login-form" class="form active" autocomplete="on" novalidate>
      <h2>Logowanie</h2>
      <div class="input-field">
        <input type="email" id="login-email" required autocomplete="email" />
        <label for="login-email">Email</label>
      </div>
      <div class="input-field">
        <input type="password" id="login-password" required autocomplete="current-password" />
        <label for="login-password">Hasło</label>
      </div>
      <button id="login-submit" type="submit">Zaloguj się</button>
      <p class="helper">Zapomniałeś hasła? <a id="recover-link" href="#">Odzyskaj dostęp</a></p>
      <p class="helper">Nie masz konta? <a class="to-signup" href="#">Zarejestruj się</a></p>
    </form>

    <!-- Rejestracja -->
    <form id="signup-form" class="form" autocomplete="on" novalidate>
      <h2>Rejestracja</h2>
      <div class="input-field">
        <input type="email" id="signup-email" required autocomplete="email" />
        <label for="signup-email">Email</label>
      </div>
      <div class="input-field">
        <input type="password" id="signup-password" required autocomplete="new-password" minlength="6" />
        <label for="signup-password">Hasło</label>
      </div>
      <button id="signup-submit" type="submit">Załóż konto</button>
      <p class="helper">Masz już konto? <a class="to-login" href="#">Przejdź do logowania</a></p>
    </form>
  </div>

  <script>
    // UI helpers
    const flash = (msg, type = "") => {
      const box = document.getElementById("flash");
      box.textContent = msg || "";
      box.className = `flash ${type}`;
    };
    const setBusy = (btn, busy, label) => {
      if (!btn) return;
      if (!btn.dataset.label && label) btn.dataset.label = label;
      btn.disabled = !!busy;
      btn.dataset.busy = busy ? "1" : "0";
      if (btn.dataset.label) btn.textContent = busy ? "Przetwarzam..." : btn.dataset.label;
    };

    const LOCAL_SESSION_KEY = "chem_session_id";
    const saveLocalSessionId = (sid) => { try { if (sid) localStorage.setItem(LOCAL_SESSION_KEY, sid); } catch {} };
    const clearLocalSessionId = () => { try { localStorage.removeItem(LOCAL_SESSION_KEY); } catch {} };
    const hasAccess = (user) => {
      const roles = (user && user.app_metadata && user.app_metadata.roles) || [];
      return roles.includes('admin') || roles.includes('active');
    };
    const setNFJwtCookie = async (user) => {
      if (!user || !hasAccess(user)) return;
      try {
        const token = await user.jwt();
        if (!token) return;
        const secure = location.protocol === "https:" ? "; Secure" : "";
        document.cookie = `nf_jwt=${token}; Path=/; SameSite=Lax${secure}`;
      } catch {}
    };
    const afterLogin = async (user) => {
      if (!user) return;
      if (!hasAccess(user)) {
        flash("Konto nieaktywne – poproś administratora o aktywację.", "warn");
        try { await netlifyIdentity.logout(); } catch {}
        clearLocalSessionId();
        return;
      }
      try {
        const sid = user.app_metadata && user.app_metadata.session_id;
        if (sid) saveLocalSessionId(sid); else clearLocalSessionId();
      } catch {}
      await setNFJwtCookie(user);
      flash("Zalogowano. Przenoszę...", "success");
      setTimeout(() => { window.location.replace("/members/"); }, 250);
    };

    document.addEventListener("DOMContentLoaded", () => {
      const tabs = Array.from(document.querySelectorAll(".tab-btn"));
      const forms = {
        login: document.getElementById("login-form"),
        signup: document.getElementById("signup-form")
      };
      const showForm = (target) => {
        const available = Object.keys(forms);
        if (!available.includes(target)) target = "login";
        tabs.forEach((btn) => btn.classList.toggle("active", btn.dataset.target === target));
        available.forEach((key) => {
          const form = forms[key];
          if (!form) return;
          if (key === target) form.classList.add("active"); else form.classList.remove("active");
        });
      };
      tabs.forEach((btn) => {
        btn.addEventListener("click", (e) => {
          e.preventDefault();
          showForm(btn.dataset.target || "login");
          flash("");
        });
      });
      Array.from(document.querySelectorAll(".to-login")).forEach((link) => {
        link.addEventListener("click", (e) => {
          e.preventDefault();
          showForm("login");
          flash("");
        });
      });
      Array.from(document.querySelectorAll(".to-signup")).forEach((link) => {
        link.addEventListener("click", (e) => {
          e.preventDefault();
          showForm("signup");
          flash("");
        });
      });

      // Jeżeli już zalogowany i aktywny → przenieś do members
      netlifyIdentity.on("init", async (user) => {
        if (!user) return;
        if (!hasAccess(user)) {
          flash("Konto nieaktywne – poproś administratora o aktywację.", "warn");
          try { await netlifyIdentity.logout(); } catch {}
          clearLocalSessionId();
          return;
        }
        await setNFJwtCookie(user);
        try {
          const sid = user.app_metadata && user.app_metadata.session_id;
          if (sid) saveLocalSessionId(sid);
        } catch {}
        window.location.replace("/members/");
      });
      netlifyIdentity.init();

      // Logowanie (bez popupa)
      const loginBtn = document.getElementById("login-submit");
      loginBtn.dataset.label = "Zaloguj się";
      document.getElementById("login-form").addEventListener("submit", async (e) => {
        e.preventDefault();
        flash("");
        const email = document.getElementById("login-email").value.trim();
        const password = document.getElementById("login-password").value;
        if (!email || !password) return flash("Uzupełnij email i hasło.", "warn");

        try {
          setBusy(loginBtn, true);
          await netlifyIdentity.gotrue.login(email, password, true);
          try { await netlifyIdentity.refresh(); } catch {}
          const user = netlifyIdentity.currentUser();
          if (user) {
            await afterLogin(user);
          } else {
            flash("Zalogowano, ale nie udało się pobrać danych użytkownika.", "error");
          }
        } catch (err) {
          // Map known errors to friendlier PL messages
          const msg = (err && (err.message || err.msg)) ? String(err.message || err.msg) : String(err || '');
          const lower = msg.toLowerCase();
          const isInvalidGrant = lower.includes('invalid_grant') || lower.includes('no user found') || lower.includes('password invalid');
          const isUnconfirmed = lower.includes('confirmation') || lower.includes('confirm') || lower.includes('email not confirmed');
          const isInactive = lower.includes('inactive') || lower.includes('nieaktywne') || lower.includes('unauthorized') || lower.includes('webhook');

          if (isInvalidGrant) {
            flash(`Nie ma takiego użytkownika z e‑mailem "${email}" lub hasło jest nieprawidłowe.`, "error");
          } else if (isInactive) {
            flash("Konto nieaktywne – poproś administratora o aktywację.", "warn");
          } else if (isUnconfirmed) {
            flash("Potwierdź swój adres e‑mail, zanim zalogujesz się do aplikacji.", "warn");
          } else {
            flash("Błąd logowania: " + (msg || 'Nieznany błąd'), "error");
          }
        } finally {
          setBusy(loginBtn, false);
        }
      });

      // Rejestracja
      const signupBtn = document.getElementById("signup-submit");
      if (signupBtn) signupBtn.dataset.label = "Załóż konto";
      document.getElementById("signup-form").addEventListener("submit", async (e) => {
        e.preventDefault();
        flash("");
        const email = document.getElementById("signup-email").value.trim();
        const password = document.getElementById("signup-password").value;
        if (!email || !password) return flash("Podaj email oraz hasło.", "warn");
        try {
          setBusy(signupBtn, true);
          await netlifyIdentity.gotrue.signup(email, password);

          // Po rejestracji spróbuj zalogować i przenieść użytkownika.
          let autoLoginSucceeded = false;
          try {
            await netlifyIdentity.gotrue.login(email, password, true);
            try { await netlifyIdentity.refresh(); } catch {}
            const user = netlifyIdentity.currentUser();
            if (user) {
              await afterLogin(user);
              autoLoginSucceeded = true;
            }
          } catch (loginErr) {
            const loginMsg = (loginErr && (loginErr.message || loginErr.msg)) ? String(loginErr.message || loginErr.msg) : '';
            const lowerLoginMsg = loginMsg.toLowerCase();
            if (lowerLoginMsg.includes('confirm')) {
              flash("Konto utworzone. Sprawdź skrzynkę i potwierdź adres e‑mail, aby się zalogować.", "success");
            } else if (lowerLoginMsg.includes('inactive') || lowerLoginMsg.includes('nieaktywne') || lowerLoginMsg.includes('unauthorized') || lowerLoginMsg.includes('webhook')) {
              flash("Konto utworzone. Administrator musi je aktywować, zanim zalogujesz się do aplikacji.", "warn");
            } else {
              flash("Konto utworzone, ale nie udało się automatycznie zalogować. Spróbuj zalogować się ręcznie.", "warn");
            }
          }

          if (!autoLoginSucceeded) {
            showForm("login");
          }
        } catch (err) {
          const msg = (err && (err.message || err.msg)) ? String(err.message || err.msg) : String(err || '');
          const lower = msg.toLowerCase();
          if (lower.includes('email') && lower.includes('exists')) {
            flash(`Konto z adresem "${email}" już istnieje.`, "error");
          } else if (lower.includes('weak-password') || lower.includes('short')) {
            flash("Hasło jest zbyt krótkie. Podaj dłuższe hasło.", "error");
          } else {
            flash("Nie udało się utworzyć konta: " + (msg || 'Nieznany błąd'), "error");
          }
        } finally {
          setBusy(signupBtn, false);
        }
      });

      // Reset hasła
      document.getElementById("recover-link").addEventListener("click", async (e) => {
        e.preventDefault();
        const email = document.getElementById("login-email").value.trim();
        if (!email) return flash("Podaj najpierw email w polu logowania.", "warn");
        try {
          await netlifyIdentity.gotrue.requestPasswordRecovery(email);
          flash("Wysłano link do resetu hasła. Sprawdź skrzynkę.", "success");
        } catch (err) {
          flash("Nie udało się wysłać linku: " + (err?.message || err), "error");
        }
      });

      // Ustaw widok zakładek na podstawie parametrów w URL
      try {
        const params = new URLSearchParams(location.search);
        if (params.has('signup') || params.get('view') === 'signup') {
          showForm('signup');
        } else {
          showForm('login');
        }
      } catch {
        showForm('login');
      }
    });
  </script>
</body>
</html>
