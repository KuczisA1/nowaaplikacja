<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Aktywacja konta</title>
  <style>
    :root {
      color-scheme: light dark;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      line-height: 1.5;
    }
    body {
      margin: 0;
      background: #f6f7fb;
      color: #16181d;
    }
    @media (prefers-color-scheme: dark) {
      body {
        background: #0e1117;
        color: #f5f7fa;
      }
      .card {
        background: rgba(255, 255, 255, 0.05);
      }
      .input, select {
        background: rgba(255, 255, 255, 0.08);
        color: inherit;
      }
    }
    .page {
      max-width: 960px;
      margin: 0 auto;
      padding: 48px 16px 64px;
    }
    h1 {
      margin-bottom: 0.5rem;
      font-size: clamp(2rem, 5vw, 2.6rem);
    }
    p.lead {
      margin-top: 0;
      margin-bottom: 2rem;
      font-size: 1.05rem;
      color: rgba(22, 24, 29, 0.72);
    }
    @media (prefers-color-scheme: dark) {
      p.lead {
        color: rgba(245, 247, 250, 0.72);
      }
    }
    .card {
      background: #fff;
      border-radius: 18px;
      padding: 24px;
      margin-bottom: 20px;
      box-shadow: 0 12px 40px rgba(22, 24, 29, 0.08);
    }
    .card h2 {
      margin-top: 0;
      margin-bottom: 1rem;
      font-size: 1.4rem;
    }
    label {
      display: block;
      font-weight: 600;
      margin-bottom: 0.35rem;
    }
    input[type="email"] {
      width: 100%;
      box-sizing: border-box;
      padding: 12px 14px;
      border-radius: 12px;
      border: 1px solid rgba(22, 24, 29, 0.12);
      font-size: 1rem;
    }
    input[type="email"]:focus {
      outline: none;
      border-color: #5a67ff;
      box-shadow: 0 0 0 3px rgba(90, 103, 255, 0.2);
    }
    .actions {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-top: 16px;
    }
    button {
      cursor: pointer;
      border: none;
      border-radius: 12px;
      font-size: 1rem;
      padding: 12px 20px;
      font-weight: 600;
      transition: transform 0.15s ease, box-shadow 0.15s ease;
    }
    button.primary {
      background: #5a67ff;
      color: #fff;
      box-shadow: 0 10px 24px rgba(90, 103, 255, 0.25);
    }
    button.secondary {
      background: rgba(22, 24, 29, 0.08);
      color: inherit;
    }
    button[disabled] {
      opacity: 0.55;
      cursor: not-allowed;
      box-shadow: none;
    }
    .status-panel {
      border-radius: 12px;
      padding: 16px;
      background: rgba(90, 103, 255, 0.08);
      color: inherit;
      margin-top: 16px;
    }
    .status-panel p {
      margin: 0.5rem 0;
    }
    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-weight: 600;
      border-radius: 999px;
      padding: 6px 14px;
      font-size: 0.95rem;
    }
    .status-badge.success {
      background: rgba(16, 185, 129, 0.12);
      color: #0f9d58;
    }
    .status-badge.destructive {
      background: rgba(240, 70, 70, 0.12);
      color: #c93030;
    }
    .status-badge.info {
      background: rgba(90, 103, 255, 0.12);
      color: #3b4bff;
    }
    .plans {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 16px;
      margin-bottom: 12px;
    }
    .plan-card {
      border: 1px solid rgba(22, 24, 29, 0.1);
      border-radius: 16px;
      padding: 18px;
      transition: border 0.2s ease, transform 0.2s ease;
      cursor: pointer;
      background: rgba(255, 255, 255, 0.92);
    }
    .plan-card.active {
      border-color: #5a67ff;
      box-shadow: 0 12px 24px rgba(90, 103, 255, 0.18);
      transform: translateY(-2px);
    }
    .plan-card input {
      margin-right: 10px;
    }
    .plan-title {
      font-weight: 700;
      margin: 0;
      font-size: 1.1rem;
    }
    .plan-desc {
      margin: 0.35rem 0 0;
      color: rgba(22, 24, 29, 0.7);
      font-size: 0.95rem;
    }
    .messages {
      margin-top: 20px;
    }
    .alert {
      padding: 14px 18px;
      border-radius: 12px;
      margin-bottom: 12px;
      border: 1px solid transparent;
      font-weight: 500;
    }
    .alert.success {
      background: rgba(16, 185, 129, 0.12);
      border-color: rgba(16, 185, 129, 0.3);
      color: #0f9d58;
    }
    .alert.error {
      background: rgba(240, 70, 70, 0.12);
      border-color: rgba(240, 70, 70, 0.25);
      color: #c93030;
    }
    .alert.info {
      background: rgba(90, 103, 255, 0.12);
      border-color: rgba(90, 103, 255, 0.25);
      color: #3b4bff;
    }
    footer {
      margin-top: 48px;
      font-size: 0.85rem;
      color: rgba(22, 24, 29, 0.6);
    }
    @media (prefers-color-scheme: dark) {
      .card {
        background: rgba(255, 255, 255, 0.06);
        box-shadow: 0 12px 40px rgba(0, 0, 0, 0.4);
      }
      .plan-card {
        background: rgba(255, 255, 255, 0.04);
      }
      .plan-desc {
        color: rgba(245, 247, 250, 0.7);
      }
      input[type="email"] {
        background: rgba(255, 255, 255, 0.08);
        color: inherit;
        border: 1px solid rgba(255, 255, 255, 0.16);
      }
      button.secondary {
        background: rgba(255, 255, 255, 0.08);
      }
    }
  </style>
</head>
<body>
  <main class="page">
    <header>
      <h1>Aktywuj dostęp</h1>
      <p class="lead">Sprawdź status subskrypcji i opłać dostęp dla swojego adresu e-mail. Wybierz okres i aktywuj konto w kilka sekund.</p>
    </header>

    <section class="card" id="email-card">
      <h2>1. Podaj adres e-mail</h2>
      <form id="status-form">
        <label for="email">Adres e-mail powiązany z kontem</label>
        <input id="email" name="email" type="email" autocomplete="email" placeholder="twoj@mail.com" required>
        <div class="actions">
          <button id="check-btn" class="primary" type="submit">Sprawdź status</button>
          <button id="clear-btn" class="secondary" type="button">Wyczyść</button>
        </div>
      </form>
      <div id="status-panel" class="status-panel" hidden>
        <div id="status-badge" class="status-badge info">Status nieznany</div>
        <p id="status-message"></p>
        <p id="status-expiry" hidden></p>
      </div>
    </section>

    <section class="card" id="plans-card" hidden>
      <h2>2. Wybierz plan subskrypcji</h2>
      <div id="plans" class="plans"></div>
      <div class="actions">
        <button id="activate-btn" class="primary" type="button">Aktywuj i zapłać</button>
      </div>
    </section>

    <section class="messages" id="messages"></section>

    <footer>
      Masz pytania lub problem z aktywacją? Skontaktuj się z&nbsp;administratorem.
    </footer>
  </main>

  <script>
    (function () {
      const API_ENDPOINT = '/.netlify/functions/stripe-activation';
      const statusForm = document.getElementById('status-form');
      const emailInput = document.getElementById('email');
      const statusPanel = document.getElementById('status-panel');
      const statusBadge = document.getElementById('status-badge');
      const statusMessage = document.getElementById('status-message');
      const statusExpiry = document.getElementById('status-expiry');
      const plansContainer = document.getElementById('plans');
      const plansCard = document.getElementById('plans-card');
      const activateBtn = document.getElementById('activate-btn');
      const checkBtn = document.getElementById('check-btn');
      const clearBtn = document.getElementById('clear-btn');
      const messages = document.getElementById('messages');

      const PLAN_DEFINITIONS = {
        day: { label: '1 dzień', description: 'Dostęp przez 24 godziny.' },
        month: { label: '1 miesiąc', description: 'Subskrypcja miesięczna (30 dni dostępu).' },
        halfyear: { label: '6 miesięcy', description: 'Subskrypcja półroczna.' },
        year: { label: '1 rok', description: 'Subskrypcja roczna.' }
      };

      let lastStatus = null;
      let isLoading = false;

      statusForm.addEventListener('submit', async (event) => {
        event.preventDefault();
        await refreshStatus();
      });

      activateBtn.addEventListener('click', async () => {
        if (!lastStatus || lastStatus.status === 'active') {
          showMessage('info', 'Konto jest już aktywne lub nie zweryfikowano statusu.');
          return;
        }
        const selectedPlan = plansContainer.querySelector('input[name="plan"]:checked');
        if (!selectedPlan) {
          showMessage('error', 'Wybierz plan subskrypcji.');
          return;
        }
        await startCheckout(selectedPlan.value);
      });

      clearBtn.addEventListener('click', () => {
        emailInput.value = '';
        lastStatus = null;
        statusPanel.hidden = true;
        plansCard.hidden = true;
        plansContainer.innerHTML = '';
        messages.innerHTML = '';
      });

      function setLoading(loading) {
        isLoading = loading;
        checkBtn.disabled = loading;
        activateBtn.disabled = loading;
        if (loading) {
          checkBtn.textContent = 'Sprawdzanie...';
        } else {
          checkBtn.textContent = 'Sprawdź status';
        }
      }

      async function refreshStatus() {
        const email = emailInput.value.trim();
        if (!email) {
          showMessage('error', 'Wpisz adres e-mail.');
          return;
        }
        setLoading(true);
        messages.innerHTML = '';
        try {
          const response = await callApi('status', { email });
          if (!response.ok) {
            showMessage('error', response.data.error || response.data.message || 'Nie udało się sprawdzić statusu.');
            updateStatusPanel(null);
            plansCard.hidden = true;
            return;
          }
          lastStatus = response.data;
          updateStatusPanel(response.data);
          renderPlans(response.data.availablePlans);
          if (response.data.status === 'active') {
            plansCard.hidden = true;
            showMessage('success', response.data.message || 'Konto jest aktywne.');
          } else {
            plansCard.hidden = false;
            showMessage('info', 'Wybierz plan i przejdź do płatności.');
          }
        } catch (err) {
          console.error(err);
          showMessage('error', 'Nie udało się połączyć z serwerem.');
        } finally {
          setLoading(false);
        }
      }

      async function startCheckout(plan) {
        if (isLoading) return;
        setLoading(true);
        try {
          const response = await callApi('checkout', { email: emailInput.value.trim(), plan });
          if (!response.ok) {
            const message = response.data && (response.data.error || response.data.message);
            if (response.status === 409 && response.data && response.data.status) {
              updateStatusPanel(response.data.status);
            }
            showMessage('error', message || 'Nie udało się rozpocząć płatności.');
            return;
          }
          if (response.data && response.data.checkoutUrl) {
            window.location.href = response.data.checkoutUrl;
            return;
          }
          showMessage('error', 'Brak adresu płatności.');
        } catch (err) {
          console.error(err);
          showMessage('error', 'Nie udało się połączyć ze Stripe.');
        } finally {
          setLoading(false);
        }
      }

      async function callApi(action, payload) {
        const res = await fetch(API_ENDPOINT, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action, ...payload })
        });
        let data;
        try {
          data = await res.json();
        } catch (err) {
          data = { error: 'Niepoprawna odpowiedź serwera.' };
        }
        return { ok: res.ok, status: res.status, data };
      }

      function renderPlans(availablePlans) {
        plansContainer.innerHTML = '';
        const plans = (Array.isArray(availablePlans) && availablePlans.length)
          ? availablePlans.filter(Boolean)
          : Object.keys(PLAN_DEFINITIONS).map((key) => ({ key, label: PLAN_DEFINITIONS[key].label }));
        plans.forEach((plan, index) => {
          const def = PLAN_DEFINITIONS[plan.key] || { label: plan.label || plan.key, description: '' };
          const card = document.createElement('label');
          card.className = 'plan-card';
          if (index === 0) {
            card.classList.add('active');
          }

          const input = document.createElement('input');
          input.type = 'radio';
          input.name = 'plan';
          input.value = plan.key;
          if (index === 0) {
            input.checked = true;
          }
          input.addEventListener('change', () => {
            plansContainer.querySelectorAll('.plan-card').forEach((el) => el.classList.remove('active'));
            card.classList.add('active');
          });

          const title = document.createElement('p');
          title.className = 'plan-title';
          title.textContent = def.label || plan.label || plan.key;

          const desc = document.createElement('p');
          desc.className = 'plan-desc';
          desc.textContent = def.description || '';

          card.appendChild(input);
          card.appendChild(title);
          card.appendChild(desc);
          plansContainer.appendChild(card);
        });
      }

      function updateStatusPanel(data) {
        if (!data) {
          statusPanel.hidden = true;
          return;
        }
        statusPanel.hidden = false;
        const badgeClass = data.status === 'active' ? 'success' : (data.status === 'inactive' ? 'destructive' : 'info');
        statusBadge.className = `status-badge ${badgeClass}`;
        statusBadge.textContent = data.status === 'active' ? 'Aktywne' : (data.status === 'inactive' ? 'Nieaktywne' : 'Nieznane');
        statusMessage.textContent = data.message || '';
        if (data.expiresAt && data.status === 'active') {
          statusExpiry.hidden = false;
          statusExpiry.textContent = formatExpiry(data.expiresAt, data.secondsRemaining);
        } else {
          statusExpiry.hidden = true;
          statusExpiry.textContent = '';
        }
      }

      function formatExpiry(expiresAt, secondsRemaining) {
        const expires = new Date(expiresAt);
        if (Number.isNaN(expires.getTime())) return '';
        const options = { dateStyle: 'long', timeStyle: 'short' };
        const formatted = new Intl.DateTimeFormat('pl-PL', options).format(expires);
        const relative = formatRelativeTime(secondsRemaining);
        return `Dostęp aktywny do ${formatted} (${relative}).`;
      }

      function formatRelativeTime(secondsRemaining) {
        if (!Number.isFinite(secondsRemaining) || secondsRemaining <= 0) return 'wygasło';
        const minutes = Math.floor(secondsRemaining / 60);
        const hours = Math.floor(minutes / 60);
        const days = Math.floor(hours / 24);
        const rtf = new Intl.RelativeTimeFormat('pl', { numeric: 'auto' });
        if (days >= 1) return rtf.format(days, 'day');
        if (hours >= 1) return rtf.format(hours, 'hour');
        if (minutes >= 1) return rtf.format(minutes, 'minute');
        return rtf.format(Math.max(1, Math.floor(secondsRemaining)), 'second');
      }

      function showMessage(type, text) {
        if (!text) {
          messages.innerHTML = '';
          return;
        }
        messages.innerHTML = '';
        const alert = document.createElement('div');
        alert.className = `alert ${type}`;
        alert.textContent = text;
        messages.appendChild(alert);
      }

      function handleQueryParams() {
        const params = new URLSearchParams(window.location.search);
        if (params.get('success') === '1') {
          showMessage('success', 'Płatność została przyjęta. Sprawdź status, aby potwierdzić aktywację konta.');
        }
        if (params.has('cancelled')) {
          showMessage('info', 'Płatność została anulowana. Możesz spróbować ponownie.');
        }
        if (params.has('email')) {
          emailInput.value = params.get('email');
        }
      }

      handleQueryParams();
    })();
  </script>
</body>
</html>
