<!doctype html>
<html lang="pl">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="referrer" content="no-referrer" />
    <meta name="x-members" content="1" />
    <meta http-equiv="Cache-Control" content="no-store" />
    <title>Odtwarzacz filmu</title>
    <style id="anti-flash">html{visibility:hidden}</style>
    <link rel="stylesheet" href="https://unpkg.com/video.js@8/dist/video-js.min.css" />
    <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
    <script defer src="/assets/js/auth.js"></script>
    <script src="https://unpkg.com/video.js@8/dist/video.min.js" defer></script>
    <script src="https://unpkg.com/videojs-youtube@3/dist/Youtube.min.js" defer></script>
    <style>
      :root {
        color-scheme: dark;
      }
      *, *::before, *::after { box-sizing: border-box; }
      html, body { height: 100%; margin: 0; background: #0b0d10; color: #e6e8eb; font-family: system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
      body { display: flex; flex-direction: column; }
      #app { flex: 1 1 auto; display: grid; grid-template-rows: 1fr; }
      .stage { position: relative; background: #000; display: flex; flex-direction: column; height: 100%; }
      .empty { flex: 1 1 auto; display: grid; place-items: center; text-align: center; padding: 32px; color: #c7cbd1; }
      .empty strong { display: block; margin-bottom: 10px; font-size: 1.1rem; color: #fff; }
      .video-js { width: 100%; height: 100%; font-size: 16px; }
      .video-js.vjs-default-skin { background-color: #000; }
      .vjs-big-play-button { border: none; }
      .plain-embed { flex: 1 1 auto; width: 100%; height: 100%; border: 0; }
      #message { position: absolute; left: 0; right: 0; top: 0; padding: 12px 16px; background: rgba(0,0,0,0.55); color: #fff; text-align: center; z-index: 20; pointer-events: none; opacity: 0; transition: opacity 220ms ease; font-size: 0.95rem; }
      #message.show { opacity: 1; }
      body[data-mode="plain"] #player { display: none !important; }
      body[data-mode="plain"] .vjs-control-bar { display: none !important; }
      body[data-mode="plain"] .vjs-big-play-button { display: none !important; }
      body[data-native-fs="1"] #message { display: none; }
      body[data-mode="plain"] #message { display: none; }
    </style>
    <script>
      (function earlyStrip(){
        try {
          const sp = new URLSearchParams(location.search);
          const keep = (sp.get('keep')||'') === '1';
          const id = (sp.get('id')||'').trim();
          const typeParam = (sp.get('type')||'').trim();
          if (id) { try { sessionStorage.setItem('yt_id', id); } catch {} }
          if (typeParam) {
            const safeType = typeParam === '2' ? '2' : '1';
            try { sessionStorage.setItem('yt_type', safeType); } catch {}
          }
          if (id && !keep) {
            const basePath = location.pathname.replace(/[^\\/]*$/, '');
            history.replaceState(null, '', basePath || '/');
          }
        } catch {}
        try { document.documentElement.style.visibility = 'visible'; } catch {}
      })();
    </script>
  </head>
  <body>
    <div id="app">
      <div class="stage" id="stage">
        <div id="message"></div>
        <div class="empty" id="empty">
          <div>
            <strong>Podaj ID filmu YouTube w URL</strong>
            <div>Użycie: <code>?id=dQw4w9WgXcQ&amp;type=1</code> albo <code>type=2</code></div>
          </div>
        </div>
        <video id="player" class="video-js vjs-default-skin" playsinline controls preload="auto"></video>
        <iframe id="plain" class="plain-embed" hidden
          referrerpolicy="no-referrer"
          allow="autoplay; picture-in-picture; fullscreen"
          allowfullscreen
          sandbox="allow-scripts allow-same-origin"></iframe>
      </div>
    </div>

    <script>
      const $ = (s) => document.querySelector(s);
      const STORAGE_KEYS = {
        volume: 'chem.videojs.volume',
        muted: 'chem.videojs.muted',
      };
      const SESSION_KEYS = {
        id: 'yt_id',
        type: 'yt_type',
      };

      const clamp = (val, min, max) => Math.min(max, Math.max(min, val));

      const saveLocal = (key, value) => {
        try { localStorage.setItem(key, value); } catch {}
      };
      const readLocal = (key) => {
        try { const raw = localStorage.getItem(key); return raw === null ? null : raw; } catch { return null; }
      };
      const saveSession = (key, value) => { try { sessionStorage.setItem(key, value); } catch {} };
      const readSession = (key) => { try { return sessionStorage.getItem(key) || ''; } catch { return ''; } };

      const stripUrlToHostOnly = () => {
        try {
          const to = location.origin + '/';
          if (location.href !== to) history.replaceState({}, '', to);
        } catch {}
      };

      const loadVolume = () => {
        const raw = readLocal(STORAGE_KEYS.volume);
        if (raw === null) return null;
        const num = Number(raw);
        if (!Number.isFinite(num)) return null;
        return clamp(num, 0, 100) / 100;
      };
      const loadMuted = () => {
        const raw = readLocal(STORAGE_KEYS.muted);
        if (raw === '1') return true;
        if (raw === '0') return false;
        return null;
      };

      const showMessage = (text, duration = 1600) => {
        const box = $('#message');
        if (!box) return;
        box.textContent = text || '';
        box.classList.toggle('show', !!text);
        if (text && duration > 0) {
          window.setTimeout(() => {
            box.classList.remove('show');
          }, duration);
        }
      };

      const showEmpty = (html) => {
        const empty = $('#empty');
        if (!empty) return;
        if (html) empty.innerHTML = html;
        empty.hidden = false;
      };
      const hideEmpty = () => {
        const empty = $('#empty');
        if (empty) empty.remove();
      };

      const makePlainEmbedUrl = (id) => {
        const params = new URLSearchParams({
          controls: '1',
          modestbranding: '1',
          rel: '0',
          playsinline: '1',
          iv_load_policy: '3',
          fs: '1',
          origin: location.origin,
        });
        return `https://www.youtube-nocookie.com/embed/${encodeURIComponent(id)}?${params.toString()}`;
      };

      const initPlainEmbed = (id) => {
        document.body.dataset.mode = 'plain';
        const iframe = $('#plain');
        if (!iframe) return;
        iframe.hidden = false;
        iframe.src = makePlainEmbedUrl(id);
        hideEmpty();
      };

      const initVideoJs = (id) => {
        document.body.dataset.mode = 'player';
        const videoEl = $('#player');
        const plain = $('#plain');
        if (plain) {
          plain.hidden = true;
          plain.removeAttribute('src');
        }
        if (!videoEl) {
          showEmpty('<div><strong>Brak elementu odtwarzacza.</strong></div>');
          return;
        }
        videoEl.classList.add('vjs-default-skin');
        const poster = `https://img.youtube.com/vi/${id}/maxresdefault.jpg`;
        videoEl.setAttribute('poster', poster);
        hideEmpty();

        const waitForVideoJs = () => new Promise((resolve, reject) => {
          let tries = 0;
          const tick = () => {
            tries += 1;
            if (window.videojs && window.videojs.Youtube) {
              resolve(window.videojs);
              return;
            }
            if (tries > 120) {
              reject(new Error('Nie udało się załadować Video.js'));
              return;
            }
            setTimeout(tick, 100);
          };
          tick();
        });

        waitForVideoJs().then((videojs) => {
          const options = {
            controls: true,
            autoplay: false,
            preload: 'auto',
            poster,
            techOrder: ['youtube'],
            sources: [{
              type: 'video/youtube',
              src: `https://www.youtube.com/watch?v=${encodeURIComponent(id)}`,
            }],
            youtube: {
              ytControls: 0,
              modestbranding: 1,
              rel: 0,
              playsinline: 1,
              ivLoadPolicy: 3,
              enablePrivacyEnhancedMode: true,
            },
          };

          const player = videojs(videoEl, options, function onReady() {
            const savedVolume = loadVolume();
            const savedMuted = loadMuted();
            if (savedMuted !== null) this.muted(savedMuted);
            if (savedVolume !== null) this.volume(savedVolume);
            showMessage('Odtwarzacz gotowy');
          });

          player.on('volumechange', () => {
            try {
              const vol = Math.round(player.volume() * 100);
              saveLocal(STORAGE_KEYS.volume, String(clamp(vol, 0, 100)));
              saveLocal(STORAGE_KEYS.muted, player.muted() ? '1' : '0');
            } catch {}
          });

          player.on('error', () => {
            const err = player.error();
            const msg = err && err.message ? err.message : 'Nieznany błąd odtwarzacza.';
            showMessage(msg, 4000);
          });

          player.on('ended', () => {
            showMessage('Koniec odtwarzania');
          });

          const adjustVolumeBy = (delta) => {
            const current = player.muted() ? 0 : player.volume();
            const next = clamp(current + delta, 0, 1);
            player.muted(next <= 0);
            player.volume(next);
            showMessage(`Głośność: ${Math.round(player.volume() * 100)}%`);
          };

          const seekBySeconds = (seconds) => {
            if (player.scrubbing()) return;
            const duration = player.duration();
            if (!Number.isFinite(duration)) {
              showMessage('Przewijanie niedostępne dla transmisji na żywo');
              return;
            }
            const next = clamp(player.currentTime() + seconds, 0, duration);
            player.currentTime(next);
            showMessage(`Pozycja: ${Math.floor(next)}s`);
          };

          const handleKey = (event) => {
            if (!player || player.ended()) return;
            const tag = (event.target && event.target.tagName || '').toLowerCase();
            if (tag === 'input' || tag === 'textarea') return;
            if (event.metaKey || event.ctrlKey || event.altKey) return;

            switch (event.key) {
              case ' ':
              case 'Spacebar':
              case 'k':
              case 'K':
                event.preventDefault();
                if (player.paused()) player.play(); else player.pause();
                break;
              case 'ArrowLeft':
                event.preventDefault();
                seekBySeconds(-5);
                break;
              case 'ArrowRight':
                event.preventDefault();
                seekBySeconds(5);
                break;
              case 'ArrowUp':
                event.preventDefault();
                adjustVolumeBy(0.05);
                break;
              case 'ArrowDown':
                event.preventDefault();
                adjustVolumeBy(-0.05);
                break;
              case 'f':
              case 'F':
                event.preventDefault();
                if (player.isFullscreen()) {
                  player.exitFullscreen();
                } else {
                  player.requestFullscreen();
                }
                break;
              default:
                break;
            }
          };

          document.addEventListener('keydown', handleKey);

          player.on('dispose', () => {
            document.removeEventListener('keydown', handleKey);
          });

          // prefer natywny fullscreen na urządzeniach dotykowych
          if (/(iPhone|iPad|iPod|Android)/i.test(navigator.userAgent || '')) {
            player.on('fullscreenchange', () => {
              document.body.dataset.nativeFs = player.isFullscreen() ? '1' : '0';
            });
          }

        }).catch((err) => {
          showEmpty(`<div><strong>Błąd inicjalizacji.</strong><div>${err.message || err}</div></div>`);
        });
      };

      document.addEventListener('DOMContentLoaded', () => {
        const params = new URLSearchParams(location.search);
        const id = (params.get('id') || readSession(SESSION_KEYS.id) || '').trim();
        const typeParam = (params.get('type') || readSession(SESSION_KEYS.type) || '').trim();
        const type = typeParam === '2' ? '2' : '1';

        if (!id) {
          showEmpty('<div><strong>Brak parametru ID filmu.</strong><div>Dodaj ?id=&lt;YouTubeID&gt; do adresu.</div></div>');
          return;
        }

        saveSession(SESSION_KEYS.id, id);
        saveSession(SESSION_KEYS.type, type);
        stripUrlToHostOnly();

        if (type === '2') {
          initPlainEmbed(id);
        } else {
          initVideoJs(id);
        }
      });
    </script>
  </body>
</html>
