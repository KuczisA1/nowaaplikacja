<!doctype html>
<html lang="pl">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Video.js YouTube Player</title>
    <meta name="x-members" content="1" />
    <meta http-equiv="Cache-Control" content="no-store" />
    <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
    <script defer src="/assets/js/auth.js"></script>

    <!-- Video.js CSS -->
    <link href="https://cdn.jsdelivr.net/npm/video.js@8/dist/video-js.min.css" rel="stylesheet" />

    <style>
      html, body { height: 100%; }
      body { margin: 0; background: #000; overflow: hidden; }

      /* Kontener trzymający player zawsze w obrębie okna */
      #wrap {
        position: fixed;
        inset: 0;
        display: grid;
        place-items: center;
        background: #000;
      }

      /* Skaluje player do maksymalnego rozmiaru bez wychodzenia poza ekran */
      .player-shell {
        position: relative;
        width: min(100vw, calc(100vh * 16 / 9));
        height: min(100vh, calc(100vw * 9 / 16));
      }

      /* Maska na górę playera, by przykryć przyciski YT */
      .player-shell::before {
        content: "";
        position: absolute;
        left: 0;
        right: 0;
        top: 0;
        height: 88px;
        z-index: 5;
        pointer-events: auto;
        background: linear-gradient(180deg, rgba(0, 0, 0, 0.9), rgba(0, 0, 0, 0));
      }

      .player-shell .video-js,
      .player-shell iframe {
        width: 100%;
        height: 100%;
      }

      .player-shell iframe {
        border: 0;
      }

      .player-shell .video-js .vjs-tech {
        width: 100%;
        height: 100%;
      }

      /* Prosty overlay, gdy brak ?id= */
      .overlay {
        position: fixed; inset: 0;
        display: grid; place-items: center;
        color: #bbb; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
        text-align: center; padding: 1rem;
      }
      .overlay strong { color: #fff; }
      .hidden { display: none !important; }
    </style>
  </head>
  <body>
    <div id="wrap">
      <div id="playerHost" class="player-shell"></div>
    </div>

    <!-- Overlay z informacją, jeśli brak parametru id -->
    <div id="hint" class="overlay hidden">
      <div>
        Podaj identyfikator filmu YouTube w adresie URL, np.<br/>
        <strong>http://localhost:1234/?id=dQw4w9WgXcQ</strong>
      </div>
    </div>

    <!-- Video.js core -->
    <script src="https://cdn.jsdelivr.net/npm/video.js@8/dist/video.min.js"></script>
    <!-- Wtyczka do YouTube -->
    <script src="https://cdn.jsdelivr.net/npm/videojs-youtube@3/dist/Youtube.min.js"></script>

    <script>
      const SANDBOX_VALUE = 'allow-scripts allow-same-origin allow-presentation';

      const hint = document.getElementById('hint');
      const host = document.getElementById('playerHost');

      let player = null;
      let sandboxObserver = null;

      const clearQueryFromUrl = () => {
        if (!window.location.search) return;
        const { origin, pathname, hash } = window.location;
        const cleanUrl = origin + pathname + (hash || '');
        history.replaceState(null, '', cleanUrl);
      };

      const ensureVideoJsSandbox = () => {
        if (!player) return;
        const iframe = player.el().querySelector('iframe');
        if (iframe && iframe.getAttribute('sandbox') !== SANDBOX_VALUE) {
          iframe.setAttribute('sandbox', SANDBOX_VALUE);
          iframe.setAttribute('allowfullscreen', '');
        }
      };

      const destroyCurrentPlayer = () => {
        if (sandboxObserver) {
          sandboxObserver.disconnect();
          sandboxObserver = null;
        }
        if (player) {
          player.dispose();
          player = null;
        }
        host.innerHTML = '';
      };

      const createVideoJsPlayer = (videoId) => {
        const video = document.createElement('video');
        video.id = 'vid1';
        video.className = 'video-js vjs-default-skin vjs-big-play-centered';
        video.setAttribute('controls', '');
        video.setAttribute('playsinline', '');
        video.setAttribute('autoplay', '');
        video.setAttribute('muted', '');
        host.appendChild(video);

        player = videojs(video, {
          techOrder: ['youtube'],
          responsive: true,
          controlBar: {
            volumePanel: { inline: false }
          },
          youtube: {
            rel: 0,
            modestbranding: 1,
            playsinline: 1
          },
          sources: [{
            type: 'video/youtube',
            src: `https://www.youtube.com/watch?v=${videoId}`
          }]
        });

        sandboxObserver = new MutationObserver(ensureVideoJsSandbox);

        player.ready(() => {
          ensureVideoJsSandbox();
          sandboxObserver.observe(player.el(), { childList: true, subtree: true });
          player.on('loadstart', ensureVideoJsSandbox);
        });

        player.on('dispose', () => {
          sandboxObserver?.disconnect();
          sandboxObserver = null;
        });
      };

      const createEmbedPlayer = (videoId) => {
        const iframe = document.createElement('iframe');
        iframe.className = 'yt-embed';
        iframe.src = `https://www.youtube.com/embed/${videoId}?autoplay=1&mute=1&rel=0&modestbranding=1&playsinline=1`;
        iframe.setAttribute('allow', 'autoplay; encrypted-media; fullscreen; picture-in-picture');
        iframe.setAttribute('sandbox', SANDBOX_VALUE);
        iframe.setAttribute('allowfullscreen', '');
        host.appendChild(iframe);
      };

      const applyStateFromUrl = () => {
        const url = new URL(window.location.href);
        const videoId = url.searchParams.get('id');
        const type = url.searchParams.get('type') || '1';

        destroyCurrentPlayer();

        if (videoId) {
          hint.classList.add('hidden');

          if (type === '2') {
            createEmbedPlayer(videoId);
          } else {
            createVideoJsPlayer(videoId);
          }

          clearQueryFromUrl();
        } else {
          hint.classList.remove('hidden');
        }
      };

      applyStateFromUrl();

      window.addEventListener('popstate', applyStateFromUrl);

      window.addEventListener('resize', () => {
        if (player) {
          player.resize();
        }
      });
    </script>
  </body>
</html>
