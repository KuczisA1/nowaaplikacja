<!doctype html>
<html lang="pl">
  <head>
    <link rel="icon" href="/assets/icon/benzene-ring.svg" type="image/svg+xml">
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Slides - ChemDisk</title>
    <!--<meta name="x-members" content="1" />-->
    <meta name="robots" content="noindex, nofollow" />
    <meta name="referrer" content="strict-origin-when-cross-origin" />
    <!--<meta http-equiv="Cache-Control" content="no-store" />-->
    <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
    <script defer src="/assets/js/auth.js"></script>
    <style id="anti-flash">html{visibility:hidden}</style>
    <script>
      // Wczesne czyszczenie paska: zapisz parametry i wyczyść query.
      (function earlyStrip(){
        try {
          const sp = new URLSearchParams(location.search);
          const keep = (sp.get('keep')||'') === '1';
          const raw = (sp.get('id')||'').trim();
          const type = (sp.get('type')||'').trim();
          if (raw || type) {
            try {
              sessionStorage.setItem('slides_id_raw', raw);
              if (type) sessionStorage.setItem('slides_type', type);
            } catch {}
            if (!keep) {
              history.replaceState(null, '', '/');
            }
          }
        } catch {}
        try { document.documentElement.style.visibility = 'visible'; } catch {}
      })();
    </script>
    <style>
      html, body { height: 100%; margin: 0; background: #0b0d10; color: #e6e8eb; font-family: system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Helvetica,Arial; }
      body { overflow: hidden; }
      #app { position: fixed; inset: 0; }
      .frame-wrap { position: fixed; inset: 0; }
      iframe.viewer { position: fixed; inset: 0; width: 100%; height: 100%; border: 0; background:#000; display: none; }
      .empty { display:grid; place-items:center; height:100%; text-align:center; padding:24px; color:#c7cbd1; }
      .empty code { background:#0f1216; padding:2px 6px; border-radius:4px; border:1px solid #1c2127; }
      #loader { position: fixed; inset: 0; z-index: 3; display: none; place-items: center; text-align:center; padding: 24px; background: #0b0d10; color: #e6e8eb; font: 16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Arial; }
      #loader .hint { opacity: .8; font-size: 14px; margin-top: .5rem; }
      #loader[aria-hidden="true"]{ display:none }
    </style>
  </head>
  <body>
    <div id="app">
      <div class="frame-wrap" id="frameWrap">
        <div class="empty" id="empty">
          <div>
            <div style="font-weight:600; margin-bottom: 8px;">Podaj parametry w URL albo z sesji</div>
            <div>Użycie: <code>slides.html?id=SLIDES_ID&amp;type=1</code></div>
            <div style="margin-top:8px; opacity:.8">Typy: 1 = preview z kontrolkami, 2 = sam podgląd (embed minimal)</div>
          </div>
        </div>
      </div>
      <iframe id="slidesFrame" class="viewer" allowfullscreen referrerpolicy="strict-origin-when-cross-origin"></iframe>
      <div id="loader" aria-hidden="true"><div><b>Ładowanie prezentacji…</b><div class="hint">Proszę czekać. To może potrwać chwilę.</div></div></div>
    </div>

    <script>
      // Proste utrudnienia (opcjonalne)
      try {
        document.addEventListener('contextmenu', e => e.preventDefault());
        document.addEventListener('keydown', e => {
          const k = (e.key||'').toLowerCase();
          if (e.keyCode === 123) return e.preventDefault();
          if ((e.ctrlKey||e.metaKey) && e.shiftKey && ['i','j','c'].includes(k)) return e.preventDefault();
          if ((e.ctrlKey||e.metaKey) && ['u','s','p'].includes(k)) return e.preventDefault();
        }, { capture:true });
      } catch {}

      // Utilsy
      const $ = (id) => document.getElementById(id);
      const showLoader = (text, hint) => {
        const box = $('loader');
        if (!box) return;
        if (text) box.querySelector('b').textContent = text;
        if (hint) box.querySelector('.hint').textContent = hint;
        box.setAttribute('aria-hidden', 'false');
        box.style.display = 'grid';
      };
      const hideLoader = () => { try { const box = $('loader'); box.setAttribute('aria-hidden','true'); box.style.display = 'none'; } catch {} };

      function extractSlidesId(input){
        const s = String(input||'').trim();
        if (!s) return '';
        try {
          const u = new URL(s);
          const m = u.pathname.match(/\/presentation\/d\/([\w-]{8,})/i);
          if (m && m[1]) return m[1];
          const idQ = u.searchParams.get('id');
          if (idQ && /[\w-]{8,}/.test(idQ)) return idQ;
        } catch {}
        return /^[\w-]{8,}$/.test(s) ? s : '';
      }

      function buildSlidesUrl(type, id){
        const cleanId = encodeURIComponent(id);
        if (Number(type) === 1) {
          // Z kontrolkami (Google'owy preview)
          return `https://docs.google.com/presentation/d/${cleanId}/preview`;
        }
        // Sam podgląd (embed minimalny UI)
        return `https://docs.google.com/presentation/d/${cleanId}/embed?start=false&loop=false&rm=minimal`;
      }

      function saveState(id, type){
        try {
          sessionStorage.setItem('slides_id_raw', id);
          sessionStorage.setItem('slides_type', String(type||1));
          sessionStorage.setItem('slides_saved_at', String(Date.now()));
        } catch {}
      }

      function loadState(){
        try {
          const raw = sessionStorage.getItem('slides_id_raw') || '';
          const type = Number(sessionStorage.getItem('slides_type') || '1');
          return { raw, type };
        } catch { return { raw:'', type:1 }; }
      }

      function stripToBase(){
        try {
          const base = location.origin + location.pathname.replace(/[^\/]*$/, '');
          history.replaceState(null, '', base);
        } catch {}
      }

      function render(type, id){
        const f = $('slidesFrame');
        const url = buildSlidesUrl(type, id);
        // pokaż loader w trakcie ładowania
        showLoader('Ładowanie prezentacji…', 'Proszę czekać. To może potrwać chwilę.');
        f.style.display = 'none';
        f.src = url;
        f.addEventListener('load', () => {
          try {
            f.style.display = 'block';
            $('empty')?.remove();
            hideLoader();
          } catch {}
        }, { once:true });
      }

      (function init(){
        // Czytaj z query jeszcze raz (jeśli anti-flash nie zdążył zapisać)
        const sp = new URLSearchParams(location.search);
        let rawFromUrl = (sp.get('id')||'').trim();
        let typeFromUrl = Number((sp.get('type')||'').trim()) || NaN;
        if (rawFromUrl || typeFromUrl) {
          saveState(rawFromUrl, typeFromUrl||1);
          stripToBase();
        }

        const { raw, type } = loadState();
        if (!raw) {
          // brak danych – pokaż info
          return;
        }
        const id = extractSlidesId(raw);
        if (!id) {
          const box = $('empty');
          if (box) box.innerHTML = '<div><b>Nieprawidłowe ID prezentacji.</b><div class="hint" style="opacity:.8;margin-top:.5rem">Podaj pełny link do Google Slides albo samo ID.</div></div>';
          return;
        }
        render(type||1, id);
      })();
    </script>
  </body>
  </html>
